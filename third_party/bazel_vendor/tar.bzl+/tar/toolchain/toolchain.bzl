"Provide access to a BSD tar via Bazel's toolchains feature"

load(":platforms.bzl", "BSDTAR_PLATFORMS")
load(":utf8_environment.bzl", "Utf8EnvironmentInfo")

TarInfo = provider(
    doc = "Provide info for executing BSD tar",
    fields = {
        # environment appears on the toolchain since it's platform-specific, and we want to pair it with the tool.
        # Currently known to be required only for the extract mode; see
        # https://github.com/bazelbuild/bazel-central-registry/issues/2256
        "default_env": "environment variables which should be set when spawning tar, to ensure reproducible results",
        "binary": "tar executable",
    },
)

def _tar_toolchain_impl(ctx):
    binary = ctx.executable.binary

    # Make the $(BSDTAR_BIN) variable available in places like genrules.
    # See https://docs.bazel.build/versions/main/be/make-variables.html#custom_variables
    template_variables = platform_common.TemplateVariableInfo({
        "BSDTAR_BIN": binary.path,
    })

    default_info = DefaultInfo(
        files = depset(ctx.files.binary + ctx.files.files),
    )
    tarinfo = TarInfo(
        default_env = ctx.attr._utf8_environment[Utf8EnvironmentInfo].environment,
        binary = binary,
    )

    # Export all the providers inside our ToolchainInfo
    # so the resolved_toolchain rule can grab and re-export them.
    # TODO: remove when support for Bazel 8 and earlier is dropped.
    toolchain_info = platform_common.ToolchainInfo(
        tarinfo = tarinfo,
        template_variables = template_variables,
        default = default_info,
    )

    return [toolchain_info, template_variables, default_info]

tar_toolchain = rule(
    implementation = _tar_toolchain_impl,
    attrs = {
        "binary": attr.label(
            doc = "a command to find on the system path",
            allow_files = True,
            executable = True,
            cfg = "exec",
        ),
        "_utf8_environment": attr.label(
            doc = "Ensure a reproducible locale is used",
            default = ":utf8_environment",
            cfg = "exec",
        ),
        "files": attr.label_list(allow_files = True),
    },
)

def _tar_toolchains_repo_impl(rctx):
    # Expose a concrete toolchain which is the result of Bazel resolving the toolchain
    # for the execution or target platform.
    # Workaround for https://github.com/bazelbuild/bazel/issues/14009
    # TODO: remove when support for Bazel 8 and earlier is dropped.
    starlark_content = """\
# @generated by @tar.bzl//tar/toolchain:toolchain.bzl

# Forward all the providers
def _resolved_toolchain_impl(ctx):
    toolchain_info = ctx.toolchains["@tar.bzl//tar/toolchain:type"]
    return [
        toolchain_info,
        toolchain_info.default,
        toolchain_info.tarinfo,
        toolchain_info.template_variables,
    ]

# Copied from java_toolchain_alias
# https://cs.opensource.google/bazel/bazel/+/master:tools/jdk/java_toolchain_alias.bzl
resolved_toolchain = rule(
    implementation = _resolved_toolchain_impl,
    toolchains = ["@tar.bzl//tar/toolchain:type"],
)
"""
    rctx.file("defs.bzl", starlark_content)

    build_content = """# @generated by @tar.bzl//tar/toolchain:toolchain.bzl
load(":defs.bzl", "resolved_toolchain")

resolved_toolchain(name = "resolved_toolchain", visibility = ["//visibility:public"])"""

    for [platform, meta] in BSDTAR_PLATFORMS.items():
        build_content += """
toolchain(
    name = "{platform}_toolchain",
    exec_compatible_with = {compatible_with},
    toolchain = "@{user_repository_name}_{platform}//:bsdtar_toolchain",
    toolchain_type = "@tar.bzl//tar/toolchain:type",
)
""".format(
            platform = platform,
            user_repository_name = rctx.attr.user_repository_name,
            compatible_with = meta.compatible_with,
        )

    rctx.file("BUILD.bazel", build_content)

tar_toolchains_repo = repository_rule(
    _tar_toolchains_repo_impl,
    doc = """Creates a repository that exposes a tar_toolchain_type target.""",
    attrs = {
        "user_repository_name": attr.string(doc = "Base name for toolchains repository (before Bazel munges it)"),
    },
)
