load("@rules_go//go:def.bzl", "go_binary")
load("@toolchain_utils//toolchain/symlink/target:defs.bzl", "toolchain_symlink_target")
load("@toolchain_utils//toolchain/info:defs.bzl", "toolchain_info")
load("@toolchain_utils//toolchain/test:defs.bzl", "toolchain_test")
load("@bazel_skylib//rules:build_test.bzl", "build_test")

toolchain_type(
    name = "type",
    visibility = ["//visibility:public"],
)

go_binary(
    name = "binary",
    srcs = ["binary.go"],
    pure = "on",
)

toolchain_symlink_target(
    name = "basename",
    target = ":binary",
)

toolchain_info(
    name = "info",
    target = ":basename",
    variable = "BINARY",
)

toolchain_info(
    name = "default",
    target = ":basename",
)

toolchain(
    name = "hermetic",
    toolchain = ":info",
    toolchain_type = ":type",
)

alias(
    name = "resolved",
    actual = "@resolved-symlink",
)

toolchain_test(
    name = "fixture-txt",
    size = "small",
    stdout = ":fixture.txt",
    toolchains = [":resolved"],
)

genrule(
    name = "generate-resolved",
    outs = ["generate.log"],
    cmd_bash = "$(BINARY) > $@",
    cmd_bat = "$(BINARY) > $@",
    tags = ["manual"],
    toolchains = [":resolved"],
)

toolchain_test(
    name = "generate-log",
    size = "small",
    stdout = ":generate.log",
    toolchains = [":resolved"],
)

genrule(
    name = "generate-default",
    outs = ["default.log"],
    cmd_bash = "$(BASENAME) > $@",
    cmd_bat = "$(BASENAME) > $@",
    tags = ["manual"],
    toolchains = [":default"],
)

toolchain_test(
    name = "default-log",
    size = "small",
    stdout = ":default.log",
    toolchains = [":resolved"],
)
