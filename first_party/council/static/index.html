<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0"
    />
    <title>AI Council Simulation</title>
    <style>
      /* ... existing styles ... */
      /* API Key Modal */
      #apiKeyModal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.8);
        justify-content: center;
        align-items: center;
      }

      .modal-content {
        background-color: #1e1e1e;
        padding: 30px;
        border-radius: 10px;
        width: 500px;
        text-align: center;
        border: 1px solid #333;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5);
      }

      .modal-content h2 {
        margin-top: 0;
        color: #fff;
      }

      .close-btn {
        background: none;
        border: none;
        color: #aaa;
        font-size: 24px;
        cursor: pointer;
        padding: 0;
        line-height: 1;
      }

      .close-btn:hover {
        color: #fff;
      }

      .modal-content button {
        background-color: #27ae60;
        color: white;
        padding: 10px 20px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-size: 1em;
        transition: background-color 0.3s;
      }

      .modal-content button:hover {
        background-color: #2ecc71;
      }

      .modal-content p {
        color: #ccc;
        font-size: 0.9em;
        margin-bottom: 20px;
        line-height: 1.5;
      }

      .modal-content input[type="password"] {
        width: 100%;
        padding: 10px;
        margin-bottom: 20px;
        border-radius: 5px;
        border: 1px solid #444;
        background-color: #2d2d2d;
        color: #fff;
        font-size: 1em;
      }

      .modal-content button {
        background-color: #27ae60;
        color: white;
        padding: 10px 20px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-size: 1em;
        transition: background-color 0.3s;
      }

      .modal-content button:hover {
        background-color: #2ecc71;
      }

      .disclaimer {
        font-size: 0.8em;
        color: #888;
        margin-top: 15px;
        text-align: left;
      }

      /* Main Layout */
      :root {
        --bg-color: #1a1a1a;
        --text-color: #e0e0e0;
        --accent-color: #4a90e2;
        --secondary-bg: #2d2d2d;
        --border-color: #404040;
        --green-status: #4caf50;
        --orange-status: #ff9800;
        --red-status: #f44336;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background-color: var(--bg-color);
        color: var(--text-color);
        margin: 0;
        display: flex;
        height: 100vh;
        overflow: hidden;
      }

      #sidebar {
        width: 300px;
        background-color: var(--secondary-bg);
        border-right: 1px solid var(--border-color);
        padding: 20px;
        display: flex;
        flex-direction: column;
      }

      #main-content {
        flex: 1;
        display: flex;
        flex-direction: column;
        padding: 20px;
        gap: 20px;
      }

      h1,
      h2,
      h3 {
        margin-top: 0;
      }

      #agent-list {
        list-style: none;
        padding: 0;
        flex: 1;
        overflow-y: auto;
      }

      .agent-item {
        padding: 10px;
        margin-bottom: 5px;
        background-color: rgba(255, 255, 255, 0.05);
        border-radius: 5px;
        display: flex;
        flex-direction: column;
        /* Stack content */
        gap: 5px;
      }

      .agent-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        width: 100%;
      }

      .agent-info {
        display: flex;
        align-items: center;
        gap: 10px;
        font-weight: bold;
      }

      .agent-role {
        font-size: 0.8em;
        color: #888;
        margin-left: 22px;
        /* Align with text */
      }

      .indicators {
        display: flex;
        gap: 5px;
        align-items: center;
      }

      .sentiment-icon {
        font-size: 1.2em;
        margin-right: 5px;
      }

      .agent-status-text {
        font-size: 0.8em;
        color: #aaa;
        font-style: italic;
      }

      .status-blocked {
        color: var(--red-status);
        font-weight: bold;
      }

      #chat-container {
        display: flex;
        flex: 1;
        gap: 20px;
        height: 0;
        /* Important for flex scrolling */
      }

      .chat-column {
        flex: 1;
        background-color: var(--secondary-bg);
        border-radius: 10px;
        display: flex;
        flex-direction: column;
        overflow: hidden;
      }

      .chat-header {
        padding: 15px;
        background-color: rgba(0, 0, 0, 0.2);
        border-bottom: 1px solid var(--border-color);
        font-weight: bold;
      }

      .messages {
        flex: 1;
        overflow-y: auto;
        padding: 15px;
        display: flex;
        flex-direction: column;
        gap: 10px;
      }

      .message {
        padding: 10px;
        border-radius: 8px;
        background-color: rgba(255, 255, 255, 0.05);
        max-width: 80%;
        word-wrap: break-word;
        overflow-wrap: break-word;
      }

      .message.system {
        align-self: center;
        background-color: transparent;
        color: #888;
        font-style: italic;
        font-size: 0.9em;
      }

      .message pre {
        background-color: rgba(0, 0, 0, 0.3);
        padding: 10px;
        border-radius: 5px;
        overflow-x: auto;
        white-space: pre-wrap;
        /* Wrap long lines in code blocks */
        word-wrap: break-word;
      }

      .message code {
        font-family: "Consolas", "Monaco", "Courier New", monospace;
        font-size: 0.9em;
      }

      .message-header {
        font-size: 0.8em;
        color: var(--accent-color);
        margin-bottom: 5px;
        display: flex;
        justify-content: space-between;
      }

      .thought-bubble {
        font-style: italic;
        color: #aaa;
        border-left: 3px solid var(--accent-color);
        padding-left: 10px;
        margin-top: 5px;
      }

      #controls {
        margin-top: 20px;
        padding-top: 20px;
        border-top: 1px solid var(--border-color);
        display: flex;
        flex-direction: column;
        gap: 10px;
      }

      button {
        background-color: var(--red-status);
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 5px;
        cursor: pointer;
        font-size: 1em;
        width: 100%;
      }

      button:hover {
        opacity: 0.9;
      }

      /* Report Modal */
      #report-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.8);
        z-index: 1000;
        justify-content: center;
        align-items: center;
      }

      #report-content {
        background-color: var(--secondary-bg);
        padding: 40px;
        border-radius: 10px;
        width: 80%;
        max-width: 800px;
        max-height: 80vh;
        overflow-y: auto;
        box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
      }

      /* Scrollbar styling */
      ::-webkit-scrollbar {
        width: 8px;
      }

      ::-webkit-scrollbar-track {
        background: var(--secondary-bg);
      }

      ::-webkit-scrollbar-thumb {
        background: #555;
        border-radius: 4px;
      }

      ::-webkit-scrollbar-thumb:hover {
        background: #777;
      }

      .btn-danger {
        background-color: #f44336;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 5px;
        cursor: pointer;
      }

      .btn-primary {
        background-color: #2196f3;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 5px;
        cursor: pointer;
      }

      .btn-secondary {
        background-color: #9c27b0;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 5px;
        cursor: pointer;
      }

      .btn-success {
        background-color: #4caf50;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 5px;
        cursor: pointer;
      }

      .post-game-options {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        justify-content: center;
        margin-top: 20px;
      }

      .modal {
        display: none;
        /* Hidden by default */
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0, 0, 0, 0.8);
        justify-content: center;
        align-items: center;
      }

      .modal-content {
        background-color: var(--secondary-bg);
        margin: auto;
        padding: 30px;
        border-radius: 10px;
        width: 80%;
        max-width: 600px;
        text-align: center;
        box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
      }

      .close-btn {
        color: #aaa;
        float: right;
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
      }

      .close-btn:hover,
      .close-btn:focus {
        color: white;
        text-decoration: none;
        cursor: pointer;
      }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  </head>

  <body>
    <!-- API Key Modal -->
    <div id="apiKeyModal">
      <div class="modal-content">
        <h2>Enter Google API Key</h2>
        <p>This experimental application requires a Google Gemini API Key to function.</p>
        <input
          type="password"
          id="apiKeyInput"
          placeholder="Enter your API Key (AIza...)"
        />
        <button onclick="submitApiKey()">Confirm & Start</button>
        <div class="disclaimer">
          <strong>Disclaimer:</strong> This is an experimental service. The API key is used solely
          for integration with Google APIs and is not shared or persisted beyond this session. By
          using this software, you acknowledge its experimental nature and waive any liability
          associated with its use.
        </div>
      </div>
    </div>

    <!-- Menu Overlay Removed -->

    <!-- Solution Popup -->
    <div
      id="solutionPopup"
      class="modal"
    >
      <div
        class="modal-content"
        style="max-width: 800px; text-align: left"
      >
        <div style="text-align: right">
          <button
            class="close-btn"
            onclick="closeSolutionPopup()"
          >
            √ó
          </button>
        </div>
        <h2 style="text-align: center; color: #4caf50">üéâ Council Approved Solution</h2>
        <div
          id="solutionContent"
          style="margin-top: 20px; line-height: 1.6; max-height: 60vh; overflow-y: auto"
        >
          <!-- Content will be injected here -->
        </div>
        <div style="text-align: center; margin-top: 20px">
          <button
            onclick="closeSolutionPopup()"
            class="btn-primary"
          >
            Close
          </button>
        </div>
      </div>
    </div>

    <div id="sidebar">
      <h2>AI Council</h2>
      <div
        id="cost-dashboard"
        style="
          background: #222;
          padding: 10px;
          margin-bottom: 15px;
          border-radius: 5px;
          border: 1px solid #444;
          font-size: 0.9em;
        "
      >
        <div style="display: flex; justify-content: space-between">
          <span>Total Tokens:</span>
          <span
            id="total-tokens"
            style="color: #4caf50"
            >0</span
          >
        </div>
        <div style="display: flex; justify-content: space-between">
          <span>Est. Cost:</span>
          <span
            id="total-cost"
            style="color: #ff9800"
            >$0.0000</span
          >
        </div>
      </div>
      <div id="connection-status">Connecting...</div>
      <h3>Active Agents</h3>
      <div class="status-bar">
        <div id="postGameStatus">Simulation is RUNNING.</div>
        <div
          id="currentPhase"
          style="margin-left: 20px; color: #aaa"
        >
          Phase: OBJECTIVE
        </div>
        <div id="agentCount">Active Agents: 0/0</div>
      </div>
      <ul id="agent-list">
        <!-- Agents will be populated here -->
      </ul>
      <div id="controls">
        <div>
          <input
            type="checkbox"
            id="autoScrollSidebar"
            checked
            onchange="toggleScrollButton('sidebar')"
          />
          <label for="autoScrollSidebar">Auto-scroll</label>
        </div>
        <button
          id="btn-scroll"
          onclick="manualScroll()"
          class="btn-secondary"
          style="display: none"
        >
          Scroll to Bottom
        </button>
        <button
          id="btn-start"
          onclick="startSimulation()"
          class="btn-success"
          disabled
          style="opacity: 0.5; cursor: not-allowed"
        >
          Waiting for Agents (0/20)...
        </button>
        <button
          id="btn-pause"
          onclick="togglePause()"
          style="display: none"
        >
          Pause Simulation
        </button>
        <button
          id="btn-menu"
          onclick="openMenu()"
          style="display: none"
          class="btn-secondary"
        >
          Open Menu
        </button>
        <a
          href="mailto:jack@jack-bradshaw.com?subject=AI Council Feedback"
          style="text-decoration: none; display: block"
        >
          <button
            class="btn-secondary"
            style="width: 100%"
          >
            Feedback
          </button>
        </a>
      </div>
    </div>

    <div id="main-content">
      <div id="chat-container">
        <!-- Group Chat -->
        <div class="chat-column">
          <div
            class="chat-header"
            style="display: flex; justify-content: space-between; align-items: center"
          >
            <span>Group Chat (All)</span>
            <div style="position: relative">
              <button
                id="groupFilterBtn"
                onclick="toggleGroupFilterMenu()"
                class="btn-secondary"
                style="font-size: 0.8em; padding: 2px 8px; min-width: auto"
              >
                Filter ‚ñº
              </button>
              <div
                id="groupFilterMenu"
                style="
                  display: none;
                  position: absolute;
                  right: 0;
                  top: 100%;
                  background: #2a2a2a;
                  border: 1px solid #444;
                  padding: 10px;
                  z-index: 1000;
                  min-width: 200px;
                  max-height: 80vh;
                  overflow-y: auto;
                  box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
                "
              >
                <label
                  style="
                    display: block;
                    margin-bottom: 8px;
                    font-weight: bold;
                    border-bottom: 1px solid #444;
                    padding-bottom: 5px;
                    cursor: pointer;
                  "
                >
                  <input
                    type="checkbox"
                    id="filter-group-all"
                    checked
                    onchange="toggleAllGroupFilters()"
                  />
                  Select All
                </label>
                <div id="groupFilterList">
                  <!-- Checkboxes populated dynamically -->
                </div>
              </div>
            </div>
          </div>
          <div
            class="messages"
            id="group-messages"
          ></div>
        </div>

        <!-- 1:1 & Thoughts Stream -->
        <div class="chat-column">
          <div
            class="chat-header"
            style="display: flex; justify-content: space-between; align-items: center"
          >
            <span>Private Chats & Thoughts</span>
            <div style="position: relative">
              <button
                id="thoughtFilterBtn"
                onclick="toggleThoughtFilterMenu()"
                class="btn-secondary"
                style="font-size: 0.8em; padding: 2px 8px; min-width: auto"
              >
                Filter ‚ñº
              </button>
              <div
                id="thoughtFilterMenu"
                style="
                  display: none;
                  position: absolute;
                  right: 0;
                  top: 100%;
                  background: #2a2a2a;
                  border: 1px solid #444;
                  padding: 10px;
                  z-index: 1000;
                  min-width: 200px;
                  max-height: 80vh;
                  overflow-y: auto;
                  box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
                "
              >
                <label
                  style="
                    display: block;
                    margin-bottom: 8px;
                    font-weight: bold;
                    border-bottom: 1px solid #444;
                    padding-bottom: 5px;
                    cursor: pointer;
                  "
                >
                  <input
                    type="checkbox"
                    id="filter-all"
                    checked
                    onchange="toggleAllThoughtFilters()"
                  />
                  Select All
                </label>
                <div id="thoughtFilterList">
                  <!-- Checkboxes populated dynamically -->
                </div>
              </div>
            </div>
          </div>
          <div
            class="messages"
            id="private-messages"
          ></div>
        </div>
      </div>
    </div>

    <!-- Post-Game Modal -->
    <!-- Pause Menu Modal -->
    <div
      id="postGameModal"
      class="modal"
    >
      <div class="modal-content">
        <div
          style="
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
          "
        >
          <h2 style="margin: 0">Control Menu</h2>
          <button
            onclick="closeMenu()"
            class="btn-secondary"
            style="padding: 5px 15px"
          >
            Close
          </button>
        </div>

        <div
          id="postGameStatus"
          style="color: #ff9800; margin-bottom: 10px"
        >
          Menu opened.
        </div>

        <!-- History Filters -->
        <div
          style="
            margin-bottom: 15px;
            text-align: left;
            background: rgba(0, 0, 0, 0.2);
            padding: 10px;
            border-radius: 5px;
          "
        >
          <label style="display: block; margin-bottom: 5px">
            <input
              type="checkbox"
              id="includePrivate"
              onchange="toggleAgentFilter()"
            />
            Include Private Messages
          </label>
          <div
            id="agentFilterDiv"
            style="display: none; margin-left: 20px"
          >
            <label>Filter by Agent (Optional):</label>
            <select
              id="filterAgent"
              style="padding: 5px; background: #333; color: white; border: 1px solid #555"
            >
              <option value="all">All Agents</option>
              <!-- Populated dynamically -->
            </select>
          </div>
        </div>

        <div class="post-game-options">
          <button
            onclick="toggleInterject()"
            class="btn-primary"
          >
            Interject
          </button>
          <button
            onclick="exitSimulation(false)"
            class="btn-danger"
          >
            Exit (No History)
          </button>
          <button
            onclick="exitSimulation(true)"
            class="btn-primary"
          >
            Exit (Save History)
          </button>
          <button
            onclick="showQueryInput()"
            class="btn-secondary"
            id="btn-query"
          >
            Query Conversation
          </button>
          <button
            onclick="requestSummary()"
            class="btn-secondary"
            id="btn-summary"
          >
            Generate Summary
          </button>
        </div>

        <!-- Interject Section -->
        <div
          id="interjectSection"
          style="
            display: none;
            margin-top: 20px;
            text-align: left;
            background: rgba(0, 0, 0, 0.2);
            padding: 15px;
            border-radius: 10px;
          "
        >
          <h3>Engineer Interjection</h3>
          <label>Recipient:</label>
          <select
            id="interjectRecipient"
            style="
              width: 100%;
              padding: 5px;
              margin-bottom: 10px;
              background: #333;
              color: white;
              border: 1px solid #555;
            "
          >
            <option value="all">All Agents</option>
            <!-- Agents populated dynamically -->
          </select>
          <label>Message:</label>
          <textarea
            id="interjectInput"
            placeholder="Enter your directive..."
            style="width: 100%; height: 60px; margin-bottom: 10px"
          ></textarea>
          <button
            onclick="submitInterjection()"
            class="btn-primary"
          >
            Send Directive
          </button>
        </div>

        <div
          id="querySection"
          style="display: none; margin-top: 20px"
        >
          <textarea
            id="queryInput"
            placeholder="Ask a question about the conversation..."
            style="width: 100%; height: 80px; margin-bottom: 10px"
          ></textarea>
          <button
            onclick="submitQuery()"
            class="btn-primary"
          >
            Ask
          </button>
          <div
            id="queryResult"
            style="
              margin-top: 10px;
              white-space: pre-wrap;
              text-align: left;
              background: rgba(0, 0, 0, 0.2);
              padding: 10px;
              border-radius: 5px;
            "
          ></div>
        </div>
      </div>
    </div>

    <!-- Report Modal -->
    <div
      id="reportModal"
      class="modal"
    >
      <div class="modal-content">
        <span
          class="close-btn"
          onclick="closeReport()"
          >&times;</span
        >
        <h2>Final Report</h2>
        <button
          onclick="copyReport()"
          class="btn-secondary"
          style="margin-bottom: 10px"
        >
          Copy Report
        </button>
        <div id="reportContent"></div>
      </div>
    </div>

    <!-- Intervention Modal -->
    <div
      id="interventionModal"
      class="modal"
      style="background: rgba(50, 0, 0, 0.9)"
    >
      <div
        class="modal-content"
        style="border: 2px solid #f44336"
      >
        <h2 style="color: #f44336">‚ö†Ô∏è Council Requesting Intervention</h2>
        <p>The agents have voted (50%+) to pause and request your guidance.</p>
        <label>Your Guidance:</label>
        <textarea
          id="guidanceInput"
          placeholder="Provide direction to resolve the deadlock..."
          style="
            width: 100%;
            height: 100px;
            margin-bottom: 15px;
            background: #333;
            color: white;
            border: 1px solid #555;
            padding: 10px;
          "
        ></textarea>
        <div style="text-align: right">
          <button
            onclick="submitGuidance()"
            class="btn-primary"
            style="background: #f44336"
          >
            Send Guidance & Resume
          </button>
        </div>
      </div>
    </div>

    <script>
      const ws = new WebSocket(`ws://${window.location.host}/ws/ui`);
      const agentList = document.getElementById("agent-list");
      const groupMessages = document.getElementById("group-messages");
      const privateMessages = document.getElementById("private-messages");
      const connectionStatus = document.getElementById("connection-status");
      const reportModal = document.getElementById("report-modal");
      const reportBody = document.getElementById("report-body");

      let currentReportText = "";

      let agents = new Map(); // ID -> {display, role, model}
      let isPaused = false; // Track simulation pause state
      let currentPhase = "OBJECTIVE";
      let expectedAgentCount = 21; // Default, updated from server

      ws.onopen = () => {
        connectionStatus.textContent = "Connected";
        connectionStatus.style.color = "#4caf50";
      };

      ws.onclose = () => {
        connectionStatus.textContent = "Disconnected";
        connectionStatus.style.color = "#f44336";
      };

      ws.onmessage = (event) => {
        const data = JSON.parse(event.data);

        if (data.type === "config") {
          // Receive expected agent count from server
          expectedAgentCount = data.expected_agent_count;
          console.log(`Expected agent count: ${expectedAgentCount}`);
          checkStartButton(); // Update button text
        } else if (data.type === "register") {
          agents.set(data.sender, {
            display: data.display_name,
            role: data.role_desc,
            model: data.model,
          });
          addAgent(data.sender);
          addAgentToFilter(data.sender, data.display_name);
        } else if (data.type === "system") {
          addSystemMessage(data.content);

          if (data.content.includes("Reporter Connected")) {
            document.getElementById("postGameStatus").textContent = "Reporter Ready.";
            document.getElementById("postGameStatus").style.color = "#4caf50";
            document.getElementById("btn-query").disabled = false;
            document.getElementById("btn-query").style.opacity = "1";
            document.getElementById("btn-summary").disabled = false;
            document.getElementById("btn-summary").style.opacity = "1";
          }

          if (data.content.includes("connected") && !data.content.includes("UI")) {
            const agentName = data.content.split(" ")[1];
            if (data.content.includes("disconnected")) {
              removeAgent(agentName);
            }
            // Don't add here, wait for register
          }
        } else if (data.type === "message") {
          if (data.recipient === "all") {
            addMessage(groupMessages, data);
          } else {
            addMessage(privateMessages, data);
          }

          updateAgentStatus(data.sender, data.status, data.sentiment, data.tokens);
        } else if (data.type === "thought") {
          addThought(data);
          updateAgentStatus(data.sender, data.status, data.sentiment, data.tokens);
        } else if (data.type === "status") {
          updateAgentStatus(data.sender, data.status, data.sentiment, data.tokens);
        } else if (data.type === "phase_update") {
          currentPhase = data.phase;
          updateMenuStatus();
          addSystemMessage(`PHASE UPDATE: Moving to ${data.phase}`);
        } else if (data.type === "solution_popup") {
          showSolutionPopup(data.content);
        } else if (data.type === "report") {
          showReport(data.content);
        } else if (data.type === "query_result") {
          document.getElementById("queryResult").textContent = data.content;
        } else if (data.type === "user_intervention_needed") {
          // Voting threshold met - pause simulation and open menu
          if (!isPaused) {
            fetch("/pause", { method: "POST" })
              .then((response) => response.json())
              .then(() => {
                isPaused = true;
                document.getElementById("btn-pause").textContent = "Resume Simulation";
                openMenu();
                alert("‚ö†Ô∏è Agent Vote Triggered: The council requests your intervention.");
              });
          } else {
            openMenu();
            alert("‚ö†Ô∏è Agent Vote Triggered: The council requests your intervention.");
          }
        }
      };

      function submitGuidance() {
        const content = document.getElementById("guidanceInput").value;
        if (!content) return;

        fetch("/submit_guidance", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ content }),
        }).then(() => {
          document.getElementById("interventionModal").style.display = "none";
          document.getElementById("guidanceInput").value = "";
        });
      }

      function getModelLabel(modelName) {
        if (!modelName || modelName === "gemini-2.5-flash-preview-09-2025") {
          return "Gemini 2.5 Flash";
        } else if (modelName === "gemini-2.0-flash-exp") {
          return "Gemini 2.0 Flash Exp";
        } else if (modelName === "gemini-exp-1206") {
          return "Gemini Exp 1206 (Thinking)";
        } else if (modelName === "gemini-3.0-pro-preview" || modelName === "gemini-3-pro-preview") {
          return "Gemini 3.0 Pro";
        } else if (modelName === "gemini-1.5-pro") {
          return "Gemini 1.5 Pro";
        } else if (modelName === "gemini-2.0-pro") {
          return "Gemini 2.0 Pro";
        } else {
          // Fallback: capitalize and clean up
          return modelName.replace("gemini-", "Gemini ").replace(/-/g, " ");
        }
      }

      function addAgent(name) {
        if (name.toLowerCase() === "system") return;

        const details = agents.get(name) || {
          display: name,
          role: "Connecting...",
          model: "",
        };
        let li = document.getElementById(`agent-${name}`);

        // Create if not exists
        if (!li) {
          li = document.createElement("li");
          li.className = "agent-item";
          li.id = `agent-${name}`;
          li.innerHTML = `
                    <div class="agent-header">
                        <div class="agent-info">
                            <div class="indicators">
                                <span class="sentiment-icon" id="sentiment-${name}" title="Sentiment">üòê</span>
                            </div>
                            <span class="agent-name"></span>
                        </div>
                        <span class="agent-status-text" id="status-${name}">IDLING üí§</span>
                    </div>
                    <div class="agent-role"></div>
                    <div class="agent-model" style="font-size: 0.7em; color: #666; margin-left: 22px; margin-top: 2px;"></div>
                `;

          // Insert alphabetically
          const currentName = details.display.toLowerCase();
          let inserted = false;
          for (let i = 0; i < agentList.children.length; i++) {
            const child = agentList.children[i];
            const childName = child.querySelector(".agent-name").textContent.toLowerCase();
            if (currentName < childName) {
              agentList.insertBefore(li, child);
              inserted = true;
              break;
            }
          }
          if (!inserted) agentList.appendChild(li);
        }

        // Update content (always update to ensure latest details)
        li.querySelector(".agent-name").textContent = details.display;
        li.querySelector(".agent-role").textContent = details.role;
        li.querySelector(".agent-model").textContent = getModelLabel(details.model);

        checkStartButton();
      }

      function checkStartButton() {
        const count = agents.size;
        const btn = document.getElementById("btn-start");
        const total = expectedAgentCount;

        if (count >= total) {
          btn.disabled = false;
          btn.textContent = "Start Simulation";
          btn.style.opacity = "1";
          btn.style.cursor = "pointer";
        } else {
          btn.disabled = true;
          btn.textContent = `Waiting for Agents (${count}/${total})...`;
          btn.style.opacity = "0.5";
          btn.style.cursor = "not-allowed";
        }

        // Update Active Agents Indicator
        const agentCountDiv = document.getElementById("agentCount");
        if (agentCountDiv) {
          agentCountDiv.textContent = `Active Agents: ${count}/${total}`;
        }
      }

      function removeAgent(name) {
        const el = document.getElementById(`agent-${name}`);
        if (el) el.remove();
      }

      const agentTokens = new Map(); // Store token count per agent

      function updateAgentStatus(name, status, sentiment, tokens) {
        if (!document.getElementById(`agent-${name}`)) addAgent(name);

        const statusEl = document.getElementById(`status-${name}`);
        const sentimentEl = document.getElementById(`sentiment-${name}`);

        if (statusEl && status) {
          statusEl.textContent = status;
          if (status.includes("BLOCKED")) {
            statusEl.classList.add("status-blocked");
          } else {
            statusEl.classList.remove("status-blocked");
          }
        }

        if (sentimentEl && sentiment) {
          // Extract emoji if present, or use full text
          const emojiMatch = sentiment.match(/[\p{Emoji_Presentation}\p{Extended_Pictographic}]/u);
          if (emojiMatch) {
            sentimentEl.textContent = emojiMatch[0];
          } else {
            sentimentEl.textContent = "üòê"; // Default
          }
          sentimentEl.title = sentiment; // Show full text on hover
        }

        // Update Tokens & Cost
        if (tokens !== undefined) {
          agentTokens.set(name, parseInt(tokens) || 0);
          updateCostDashboard();
        }
      }

      function updateCostDashboard() {
        let totalTokens = 0;
        agentTokens.forEach((count) => (totalTokens += count));

        const tokensEl = document.getElementById("total-tokens");
        if (tokensEl) tokensEl.textContent = totalTokens.toLocaleString();

        // Est. Cost: Blended rate (~$0.10/1M tokens)
        const cost = (totalTokens / 1000000) * 0.1;
        const costEl = document.getElementById("total-cost");
        if (costEl) costEl.textContent = `$${cost.toFixed(4)}`;
      }

      function addSystemMessage(text) {
        const div = document.createElement("div");
        div.className = "message system";
        div.textContent = text;
        groupMessages.appendChild(div);
        scrollToBottom(groupMessages);
      }

      function getDisplayName(id) {
        if (id === "Engineer") return "Engineer";
        if (id === "system") return "System";
        if (id === "all") return "All";
        const agent = agents.get(id);
        if (!agent) {
          console.warn(
            `getDisplayName failed for ID: ${id}. Agents map keys:`,
            Array.from(agents.keys())
          );
        }
        return agent ? agent.display : id;
      }

      function addMessage(container, data) {
        const senderName = getDisplayName(data.sender);
        const recipientName = getDisplayName(data.recipient);

        const div = document.createElement("div");
        if (data.recipient === "all") {
          div.className = "message";
          div.dataset.sender = data.sender; // For filtering
          div.innerHTML = `
                    <div class="message-header">
                        <span>${senderName} &rarr; ${recipientName}</span>
                    </div>
                    <div>${marked.parse(data.content)}</div>
                `;

          // Check group filter immediately
          if (!isAgentVisibleInGroup(data.sender)) {
            div.style.display = "none";
          }

          container.appendChild(div);
          scrollToBottom(container);
        } else {
          div.className = "message private";
          div.dataset.sender = data.sender; // For filtering (keep ID)
          div.innerHTML = `
                    <div class="message-header">
                        <span>${senderName} ‚ûî ${recipientName}</span>
                        <span class="timestamp">${new Date().toLocaleTimeString()}</span>
                    </div>
                    <div class="message-content">${marked.parse(data.content)}</div>
                `;
          privateMessages.appendChild(div);

          // Check filter visibility immediately
          if (!isAgentVisible(data.sender)) {
            div.style.display = "none";
          }

          scrollToBottom(privateMessages);
        }
      }

      function addThought(data) {
        const senderName = getDisplayName(data.sender);

        const div = document.createElement("div");
        div.className = "message thought";
        div.dataset.sender = data.sender; // For filtering (keep ID)
        div.innerHTML = `
                <div class="message-header">
                    <span>${senderName} (Thought)</span>
                    <span class="timestamp">${new Date().toLocaleTimeString()}</span>
                </div>
                <div class="thought-bubble">${marked.parse(data.content)}</div>
            `;
        privateMessages.appendChild(div);

        // Check filter visibility immediately
        if (!isAgentVisible(data.sender)) {
          div.style.display = "none";
        }

        scrollToBottom(privateMessages);
      }

      // --- Filter Logic (Private/Thoughts) ---
      let hiddenAgents = new Set(); // For Private/Thoughts
      let hiddenGroupAgents = new Set(); // For Group Chat (Independent)

      function toggleAgentVisibility(agentId) {
        if (hiddenAgents.has(agentId)) {
          hiddenAgents.delete(agentId);
        } else {
          hiddenAgents.add(agentId);
        }
        applyFilters();
      }

      function toggleGroupAgentVisibility(agentId) {
        if (hiddenGroupAgents.has(agentId)) {
          hiddenGroupAgents.delete(agentId);
        } else {
          hiddenGroupAgents.add(agentId);
        }
        applyGroupFilters();
      }

      function isAgentVisible(agentId) {
        return !hiddenAgents.has(agentId);
      }

      function isAgentVisibleInGroup(agentId) {
        return !hiddenGroupAgents.has(agentId);
      }

      function applyFilters() {
        // Private Messages
        const messages = document.getElementById("private-messages").children;
        for (let msg of messages) {
          const sender = msg.dataset.sender;
          if (sender && hiddenAgents.has(sender)) {
            msg.style.display = "none";
          } else {
            msg.style.display = ""; // Reset to CSS default
          }
        }
        updateFilterList(); // Update checkboxes
      }

      function applyGroupFilters() {
        // Group Messages
        const messages = document.getElementById("group-messages").children;
        for (let msg of messages) {
          const sender = msg.dataset.sender;
          if (sender && hiddenGroupAgents.has(sender)) {
            msg.style.display = "none";
          } else {
            msg.style.display = ""; // Reset to CSS default
          }
        }
        updateGroupFilterList();
      }

      function toggleThoughtFilterMenu() {
        const menu = document.getElementById("thoughtFilterMenu");
        menu.style.display = menu.style.display === "none" ? "block" : "none";
        if (menu.style.display === "block") {
          updateFilterList();
        }
      }

      function toggleGroupFilterMenu() {
        const menu = document.getElementById("groupFilterMenu");
        menu.style.display = menu.style.display === "none" ? "block" : "none";
        if (menu.style.display === "block") {
          updateGroupFilterList();
        }
      }

      function updateFilterList() {
        const list = document.getElementById("thoughtFilterList");
        list.innerHTML = "";

        // Sort agents alphabetically for the filter list too
        const sortedAgents = Array.from(agents.entries()).sort((a, b) => {
          return a[1].display.localeCompare(b[1].display);
        });

        sortedAgents.forEach(([id, details]) => {
          const div = document.createElement("div");
          div.style.marginBottom = "5px";
          div.innerHTML = `
                    <label style="cursor: pointer;">
                        <input type="checkbox" ${!hiddenAgents.has(id) ? "checked" : ""} 
                            onchange="toggleAgentVisibility('${id}')">
                        ${details.display}
                    </label>
                `;
          list.appendChild(div);
        });

        // Update "Select All" checkbox
        const allCheckbox = document.getElementById("filter-all");
        allCheckbox.checked = hiddenAgents.size === 0;
        allCheckbox.indeterminate = hiddenAgents.size > 0 && hiddenAgents.size < agents.size;
      }

      function updateGroupFilterList() {
        const list = document.getElementById("groupFilterList");
        list.innerHTML = "";

        // Sort agents alphabetically
        const sortedAgents = Array.from(agents.entries()).sort((a, b) => {
          return a[1].display.localeCompare(b[1].display);
        });

        sortedAgents.forEach(([id, details]) => {
          const div = document.createElement("div");
          div.style.marginBottom = "5px";
          div.innerHTML = `
                    <label style="cursor: pointer;">
                        <input type="checkbox" ${!hiddenGroupAgents.has(id) ? "checked" : ""} 
                            onchange="toggleGroupAgentVisibility('${id}')">
                        ${details.display}
                    </label>
                `;
          list.appendChild(div);
        });

        // Update "Select All" checkbox
        const allCheckbox = document.getElementById("filter-group-all");
        allCheckbox.checked = hiddenGroupAgents.size === 0;
        allCheckbox.indeterminate =
          hiddenGroupAgents.size > 0 && hiddenGroupAgents.size < agents.size;
      }

      function toggleAllThoughtFilters() {
        const allCheckbox = document.getElementById("filter-all");
        if (allCheckbox.checked) {
          hiddenAgents.clear(); // Show all
        } else {
          // Hide all (add all IDs)
          agents.forEach((_, id) => hiddenAgents.add(id));
        }
        applyFilters();
      }

      function toggleAllGroupFilters() {
        const allCheckbox = document.getElementById("filter-group-all");
        if (allCheckbox.checked) {
          hiddenGroupAgents.clear(); // Show all
        } else {
          // Hide all
          agents.forEach((_, id) => hiddenGroupAgents.add(id));
        }
        applyGroupFilters();
      }

      function showSolutionPopup(content) {
        const popup = document.getElementById("solutionPopup");
        const contentDiv = document.getElementById("solutionContent");
        contentDiv.innerHTML = marked.parse(content);
        popup.style.display = "block";
      }

      function closeSolutionPopup() {
        document.getElementById("solutionPopup").style.display = "none";
      }

      // Close menus when clicking outside
      window.onclick = function (event) {
        if (
          !event.target.matches("#thoughtFilterBtn") &&
          !event.target.closest("#thoughtFilterMenu")
        ) {
          document.getElementById("thoughtFilterMenu").style.display = "none";
        }
        if (!event.target.matches("#groupFilterBtn") && !event.target.closest("#groupFilterMenu")) {
          document.getElementById("groupFilterMenu").style.display = "none";
        }
      };

      function scrollToBottom(element) {
        const autoScroll = document.getElementById("autoScrollSidebar").checked;
        if (autoScroll) {
          element.scrollTop = element.scrollHeight;
        }
      }

      function manualScroll() {
        groupMessages.scrollTop = groupMessages.scrollHeight;
        privateMessages.scrollTop = privateMessages.scrollHeight;
      }

      function toggleScrollButton(source) {
        const sidebar = document.getElementById("autoScrollSidebar");
        const menu = document.getElementById("autoScrollMenu");

        if (source === "sidebar") {
          menu.checked = sidebar.checked;
        } else if (source === "menu") {
          sidebar.checked = menu.checked;
        }

        const autoScroll = sidebar.checked;
        document.getElementById("btn-scroll").style.display = autoScroll ? "none" : "block";
      }

      function stopSimulation() {
        if (confirm("Are you sure you want to STOP the simulation?")) {
          fetch("/stop", { method: "POST" })
            .then((response) => response.json())
            .then((data) => {
              console.log("Simulation stopped.");
              alert("Simulation Stopped.");
              window.location.reload();
            });
        }
      }

      function startSimulation() {
        fetch("/start", { method: "POST" })
          .then((response) => response.json())
          .then((data) => {
            console.log("Agents started.");
            document.getElementById("btn-start").style.display = "none";
            document.getElementById("btn-pause").style.display = "inline-block";
            document.getElementById("btn-menu").style.display = "inline-block";
            isPaused = false;
          });
      }

      function togglePause() {
        if (isPaused) {
          // Resume
          fetch("/resume", { method: "POST" })
            .then((response) => response.json())
            .then((data) => {
              console.log("Agents resumed.");
              isPaused = false;
              document.getElementById("btn-pause").textContent = "Pause Simulation";
              const menuBtn = document.getElementById("menuPauseBtn");
              if (menuBtn) {
                menuBtn.textContent = "Pause Simulation";
                menuBtn.style.backgroundColor = "#ff9800";
              }
              updateMenuStatus();
            });
        } else {
          // Pause
          fetch("/pause", { method: "POST" })
            .then((response) => response.json())
            .then((data) => {
              console.log("Agents paused.");
              isPaused = true;
              document.getElementById("btn-pause").textContent = "Resume Simulation";
              const menuBtn = document.getElementById("menuPauseBtn");
              if (menuBtn) {
                menuBtn.textContent = "Resume Simulation";
                menuBtn.style.backgroundColor = "#4CAF50";
              }
              updateMenuStatus();
            });
        }
      }

      function openMenu() {
        document.getElementById("postGameModal").style.display = "block";
        populateInterjectRecipients();
        updateMenuStatus();
      }

      function closeMenu() {
        document.getElementById("postGameModal").style.display = "none";
      }

      function updateMenuStatus() {
        const statusDiv = document.getElementById("postGameStatus");
        if (isPaused) {
          statusDiv.textContent = "Simulation is PAUSED.";
          statusDiv.style.color = "#ff5555";
        } else {
          statusDiv.textContent = "Simulation is RUNNING.";
          statusDiv.style.color = "#55ff55";
        }

        // Update Phase
        const phaseDiv = document.getElementById("currentPhase");
        if (phaseDiv) {
          phaseDiv.textContent = "Phase: " + currentPhase;
        }
      }

      function toggleInterject() {
        const el = document.getElementById("interjectSection");
        el.style.display = el.style.display === "none" ? "block" : "none";
      }

      function toggleAgentFilter() {
        const checkbox = document.getElementById("includePrivate");
        const div = document.getElementById("agentFilterDiv");
        div.style.display = checkbox.checked ? "block" : "none";
      }

      function populateInterjectRecipients() {
        const select = document.getElementById("interjectRecipient");
        const filterList = document.getElementById("filterAgentList");

        // Keep "All Agents" for Interject
        select.innerHTML = '<option value="all">All Agents</option>';

        // Clear Filter List
        filterList.innerHTML = "";

        // Add "All Agents" Checkbox
        const allDiv = document.createElement("div");
        allDiv.innerHTML = `<label><input type="checkbox" value="all" checked onchange="toggleAllAgentFilter(this)"> All Agents</label>`;
        filterList.appendChild(allDiv);

        agents.forEach((details, id) => {
          // Interject Dropdown
          const option = document.createElement("option");
          option.value = id;
          option.textContent = details.display;
          select.appendChild(option);

          // Filter Checkbox
          const div = document.createElement("div");
          div.innerHTML = `<label><input type="checkbox" value="${id}" class="agent-filter-checkbox" checked> ${details.display}</label>`;
          filterList.appendChild(div);
        });
      }

      function toggleAllAgentFilter(source) {
        const checkboxes = document.querySelectorAll(".agent-filter-checkbox");
        checkboxes.forEach((cb) => (cb.checked = source.checked));
      }

      function applyAgentFilter() {
        const allChecked = document.querySelector('input[value="all"]').checked;
        const checkboxes = document.querySelectorAll(".agent-filter-checkbox");
        const selectedAgents = new Set();

        checkboxes.forEach((cb) => {
          if (cb.checked) selectedAgents.add(cb.value);
        });

        const messages = document.getElementById("private-messages").children;
        for (let msg of messages) {
          const sender = msg.getAttribute("data-sender");
          const recipient = msg.getAttribute("data-recipient");

          // Show if "All" is checked OR sender is selected OR recipient is selected (for 1:1 context)
          // Simplified: Show if sender is in selected list
          if (allChecked || selectedAgents.has(sender) || selectedAgents.has(recipient)) {
            msg.style.display = "block";
          } else {
            msg.style.display = "none";
          }
        }
      }

      function submitInterjection() {
        const recipient = document.getElementById("interjectRecipient").value;
        const content = document.getElementById("interjectInput").value;

        if (!content) return;

        fetch("/interject", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ recipient, content }),
        }).then(() => {
          alert("Directive Sent!");
          document.getElementById("interjectInput").value = "";
          // Optional: Resume automatically? Or let user decide.
        });
      }

      function exitSimulation(save) {
        fetch(`/shutdown?save_history=${save}`, { method: "POST" })
          .then((response) => response.json())
          .then((data) => {
            document.getElementById("postGameModal").style.display = "none";
            const overlay = document.getElementById("exitOverlay");
            overlay.style.display = "flex";

            if (data.saved_file) {
              document.getElementById("savedLocation").style.display = "block";
              document.getElementById("savedPath").textContent = data.saved_file;
            }
          })
          .catch((err) => {
            // Even if fetch fails (server dies), show overlay
            document.getElementById("postGameModal").style.display = "none";
            document.getElementById("exitOverlay").style.display = "flex";
          });
      }

      function showQueryInput() {
        document.getElementById("querySection").style.display = "block";
      }

      function submitQuery() {
        const input = document.getElementById("queryInput");
        const query = input.value;
        if (!query) return;

        const includePrivate = document.getElementById("includePrivate").checked;
        const filterAgent = document.getElementById("filterAgent").value;

        document.getElementById("queryResult").textContent = "Analyzing...";

        fetch("/query", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            query: query,
            filter_agent: filterAgent,
          }),
        })
          .then((response) => response.json())
          .then((data) => {
            document.getElementById("queryResult").textContent = data.answer;
          })
          .catch((err) => {
            document.getElementById("queryResult").textContent = "Error: " + err;
          });
      }

      function requestSummary() {
        const includePrivate = document.getElementById("includePrivate").checked;
        const filterAgent = document.getElementById("filterAgent").value;

        socket.send(
          JSON.stringify({
            type: "message",
            recipient: "reporter",
            content: JSON.stringify({
              action: "generate_report",
              include_private: includePrivate,
              filter_agent: filterAgent,
            }),
          })
        );
        alert("Report requested. It will appear here shortly.");
      }

      function showReport(markdown) {
        currentReportText = markdown;
        const html = marked.parse(markdown);
        document.getElementById("reportContent").innerHTML = html;
        document.getElementById("reportModal").style.display = "block";
      }

      function closeReport() {
        document.getElementById("reportModal").style.display = "none";
        document.getElementById("postGameModal").style.display = "block";
      }

      function copyReport() {
        navigator.clipboard.writeText(currentReportText).then(() => {
          alert("Report copied to clipboard!");
        });
      }

      // API Key Logic
      async function checkConfig() {
        try {
          const response = await fetch("/config/status");
          const data = await response.json();
          if (!data.configured) {
            document.getElementById("apiKeyModal").style.display = "flex";
          }
        } catch (e) {
          console.error("Failed to check config status:", e);
        }
      }

      async function submitApiKey() {
        const apiKey = document.getElementById("apiKeyInput").value.trim();
        if (!apiKey) {
          alert("Please enter a valid API Key.");
          return;
        }

        try {
          const response = await fetch("/config/setup", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ api_key: apiKey }),
          });
          const data = await response.json();
          if (data.status === "success") {
            document.getElementById("apiKeyModal").style.display = "none";
          } else {
            alert("Failed to configure API Key.");
          }
        } catch (e) {
          console.error("Failed to submit API Key:", e);
          alert("Error submitting API Key.");
        }
      }

      // Initialize
      checkConfig();
      // connectWebSocket(); // Removed as ws is initialized at top
    </script>
  </body>
</html>
